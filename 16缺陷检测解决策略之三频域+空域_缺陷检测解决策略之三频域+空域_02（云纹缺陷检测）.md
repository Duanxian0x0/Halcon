![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/c7c76fcfb2084942a13a1e22402fe178.png)

```cpp
* 云纹缺陷检测，lcd

* 1. 读取图像
* 2. 傅里叶变换（对图像增强，目的为了缺陷更加明星）
* 3. 差分(带缺陷的图像-不带缺陷=缺陷)：这里是增强缺陷显示，不是直接提取缺陷，用来差分的思想
* 4. 找线算子，找到了缺陷


* 读取图像

read_image (Image, 'lcd/mura_defects_blur_01')

* 获取图像大小
get_image_size (Image, Width, Height)

decompose3 (Image, R, G, B)
* 1傅里叶变换,2生成频域图像
fft_generic (B, ImageFFT, 'to_freq', -1, 'none', 'dc_center', 'complex')

* 3生成卷积核
* 高斯滤波，通过低频区域，增强背景
gen_gauss_filter (ImageGauss, 100, 100, 0, 'n', 'dc_center', Width, Height)

* 4利用卷积核对频域图像进行滤波
convol_fft (ImageFFT, ImageGauss, ImageConvol)


* 5频域图像进行转为空域图像
fft_generic (ImageConvol, ImageFFT1, 'from_freq', 1, 'none', 'dc_center', 'byte')

* 差分(原图-背景)
sub_image (B, ImageFFT1, ImageSub, 2, 100)


* 缩小图像，（1图像变小，检测速度变快，2缺陷变小，降低干扰）
zoom_image_factor (ImageSub, ImageZoomed, 0.4, 0.4, 'constant')


*** 不检测边缘区域图像，降低干扰
* 获取区域
get_domain (ImageZoomed, Domain)
* 腐蚀
erosion_rectangle1 (Domain, RegionErosion, 20, 20)

reduce_domain (ImageZoomed, RegionErosion, ImageReduced)




* 找线缺陷进行一个提取 17 最大线宽  25,3对比度阈值（线边缘的对比度情况多少算是线）
* 输出：Sigma, Low, High
calculate_lines_gauss_parameters (17, [25,3], Sigma, Low, High)

lines_gauss (ImageReduced, Lines, Sigma, Low, High, 'dark', 'true', 'gaussian', 'true')

* 计算缺陷数量
count_obj (Lines, Number)

if(Number>0)
    dev_get_window (WindowHandle)
    disp_message (WindowHandle, 'NG', 'window', 12, 12, 'red', 'true')
endif
```

```csharp

dev_close_window ()
dev_update_off ()
Path := 'lcd/mura_defects_blur_'
* 读取图像
read_image (Image, Path + '01')
* 获取图像大小
get_image_size (Image, Width, Height)
* 窗口显示设置
dev_open_window_fit_size (0, 0, Width, Height, 640, 480, WindowHandle)
set_display_font (WindowHandle, 14, 'mono', 'true', 'false')
dev_set_draw ('margin')
dev_set_line_width (3)
dev_set_color ('red')
ScaleFactor := 0.4
* 计算找线参数（重要） 17 最大线宽  [25,3] 对比度阈值
calculate_lines_gauss_parameters (17, [25,3], Sigma, Low, High)
* 遍历
for f := 1 to 3 by 1
    * 读取图像1.读取图像，并转灰度图像
    
    read_image (Image, Path + f$'.2i')
    * 分解通道
    decompose3 (Image, R, G, B)
    * 快速傅里叶变换
      * 2.傅里叶变换，空间域转频域
*      rft_generic (B, ImageFFT, 'to_freq', 'none', 'complex', Width)
     fft_generic (B, ImageFFT2, 'to_freq', -1, 'none', 'dc_center', 'complex')
    * 高斯滤波（低通滤波，通过低频，保留背景）
     *  3.生成对应的滤波操作
*     gen_gauss_filter (ImageGauss, 100, 100, 0, 'n', 'rft', Width, Height)
     gen_gauss_filter (ImageGauss2, 100, 100, 0, 'n', 'dc_center', Width, Height)
    * 卷积
     *  4.对频域进行滤波操作
  *   convol_fft (ImageFFT, ImageGauss, ImageConvol)
    
    convol_fft (ImageFFT2, ImageGauss2, ImageConvol2)
    * 反傅里叶变换
    *   5.反傅里叶变换，频域转空间域
  *   rft_generic (ImageConvol, ImageFFT1, 'from_freq', 'none', 'byte', Width)
    
    
    
     fft_generic (ImageConvol2, ImageFFT3, 'from_freq', -1, 'none', 'dc_center', 'byte')
    * 图像相减
    * 差分思想
     *  sub_image (B, ImageFFT1, ImageSub, 2, 100)
     sub_image (B, ImageFFT3, ImageSub, 2, 100)
     
     *   6.缺陷检测
    * 缩放图片（用于提高速度，去除干扰等）
    zoom_image_factor (ImageSub, ImageZoomed, ScaleFactor, ScaleFactor, 'constant')
    * 获取图像区域
    get_domain (ImageZoomed, Domain)
    * 腐蚀
    erosion_rectangle1 (Domain, RegionErosion, 7, 7)
    * 获取图像
    reduce_domain (ImageZoomed, RegionErosion, ImageReduced)
    * 找线算子（重要）
    lines_gauss (ImageReduced, Lines, Sigma, Low, High, 'dark', 'true', 'gaussian', 'true')
    * 生产几何变换矩阵
    hom_mat2d_identity (HomMat2DIdentity)
    hom_mat2d_scale_local (HomMat2DIdentity, 1 / ScaleFactor, 1 / ScaleFactor, HomMat2DScale)
    * 仿射变换
    affine_trans_contour_xld (Lines, Defects, HomMat2DScale)
    * 显示图像
    dev_display (Image)
    dev_display (Defects)
    if (f < 3)
        disp_continue_message (WindowHandle, 'black', 'true')
        stop ()
    endif
endfor


```

