![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/4d76c1e2928d48df883632bbe56b8c8b.png)

```cpp

* 读取图像（模板标准图像）
read_image (Image, 'ampoules/ampoules_01')

* 做模板,做定位
gen_rectangle1 (Rectangle,230, 280, 317, 330)

reduce_domain (Image, Rectangle, ImageReduced)

* 创建模块
create_shape_model (ImageReduced, 'auto', -0.39, 0.79, 'auto', 'auto', 'use_polarity', 'auto', 'auto', ModelID)


get_image_size (Image, Width, Height)
*** 测量区域的确定
gen_measure_rectangle2 (0, 0, rad(90), 75, 20, Width, Height, 'nearest_neighbor', MeasureHandle)
* 可视化测量卡尺
gen_rectangle2 (Rectangle2, 0, 0, rad(90), 75, 20)
* 1.读取图像 
* 2.定位
* 3.获取ROI（感兴趣）区域
* 4.图像预处理 
* 5.图像算法处理
* 6.结果输出 

* 1.读取图像 
read_image (Image1, 'ampoules/ampoules_02')

* 2.定位
* 0 匹配所有符合条件
find_shape_model (Image1, ModelID, -0.39, 0.79, 0.7, 0, 0.5, 'least_squares', 0, 0.9, Row, Column, Angle, Score)
gen_cross_contour_xld (Cross, Row, Column, 6, Angle)

* 获取平均高度
MeanRow := mean(Row)

* 标准液体高度
HighLevlStd := MeanRow-160
* 阈值范围
tol := 15
* ROI区域
gen_rectangle2 (Rectangle1, HighLevlStd, mean(Column), 0, (max(Column)-min(Column))/2, tol)


for Index := 0 to |Score|-1 by 1
    * 移动测量对象
    translate_measure (MeasureHandle, MeanRow-135, Column[Index])
    * 显示测量卡尺
    gen_rectangle2 (Rectangle3, MeanRow-135, Column[Index], rad(90), 75, 20)
    
    * 测量
    measure_pos (Image1, MeasureHandle, 1, 5, 'all', 'first', RowEdge, ColumnEdge, Amplitude, Distance)
    * 显示液面
    gen_cross_contour_xld (Cross1, RowEdge, ColumnEdge, 16, Angle)
    
    * 判定是否是NG
    if(abs(RowEdge-HighLevlStd)>tol)
        dev_get_window (WindowHandle)
        disp_message (WindowHandle, 'NG', 'window', 12, 12, 'red', 'true')
    else
          dev_get_window (WindowHandle)
        disp_message (WindowHandle, 'OK', 'window', 12, 12, 'green', 'true')
    endif
    
    
    
endfor

```

```cpp

 *一 模板制作
* 窗口设置
dev_close_window ()
dev_update_off ()

*1.读取图像，并获取图像大小
* 读取图像
read_image (Image, 'ampoules/ampoules_01')
* 获取图像大小
get_image_size (Image, Width, Height)
* 窗口显示设置
dev_open_window_fit_image (Image, 0, 0, -1, -1, WindowHandle)
dev_set_line_width (2)
dev_set_draw ('margin')
set_display_font (WindowHandle, 16, 'mono', 'true', 'false')

*2.确定测量区域
* 生成测量矩形对象(量程 150 和 40)
gen_measure_rectangle2 (0, 0, rad(90), 75, 20, Width, Height, 'bilinear', MeasureHandle)

*3.创建模板
* 生成矩形区域
gen_rectangle1 (Rectangle, 230, 280, 317, 330)
* 获取区域图像
reduce_domain (Image, Rectangle, ImageModel)
* 创建模板匹配模型
create_shape_model (ImageModel, 'auto', 0, 0, 'auto', 'auto', 'use_polarity', 'auto', 'auto', ModelID)



* 阈值
Tolerance := 15
* 图像数量
NumImages := 8

* 遍历所有图像
for Index := 1 to NumImages by 1
    *1.读取图像
    * 读取图像
    read_image (Image, 'ampoules/ampoules_' + Index$'.2d')
    * 
    ColumnEdges := []
    
    FillLevelHeight := []
    * 模板匹配
    *2.定位（模板匹配定位）
    find_shape_model (Image, ModelID, 0, 0, 0.7, 0, 0.1, 'least_squares', 0, 0.9, Row, Column, Angle, Score)
    * 获取Y的均值
    MeanRow := mean(Row)
    * 确定液体标准高度
    RefLevel := MeanRow - 160

    dev_display (Image)
    dev_set_line_width (1)
    dev_set_color ('white')
    * 生成矩形（ROI区域）
    gen_rectangle2 (AcceptLevel, RefLevel, mean(Column), 0, 30 + (max(Column) - min(Column)) / 2, Tolerance)
    dev_display (AcceptLevel)
    dev_set_line_width (2)

    Errors := 0
    * 遍历所有匹配对象
    for Idx := 0 to |Score| - 1 by 1
        * 测量对象，向下移动135像素
        translate_measure (MeasureHandle, MeanRow - 135, Column[Idx])
        * 显示测量范围
        gen_rectangle2 (Rectangle1,MeanRow - 135, Column[Idx], rad(90), 75, 20)
        *3.测量
        * 测量
        measure_pos (Image, MeasureHandle, 2, 7, 'all', 'first', RowEdge, ColumnEdge, Amplitude, Distance)
        * 边缘Y
        FillLevelHeight := [FillLevelHeight,RowEdge]
        * 边缘X
        ColumnEdges := [ColumnEdges,ColumnEdge]
        * 显示十字叉
        gen_cross_contour_xld (Cross, RowEdge, ColumnEdge, 15, 0)
        * 生成矩形(卡出的点，周围的矩形)
        gen_rectangle2 (FillLevel, RowEdge, ColumnEdge, 0, 28, 20)
        *4.显示结果并处理
        * 如果超过阈值，则报NG（红）,否则OK
        * 边缘Y-液体标准高度 大于 阈值Tolerance，则error
        if (abs(FillLevelHeight[Idx] - RefLevel) >= Tolerance)
            gen_rectangle2 (ChamberSingle, MeanRow - 133, Column[Idx], 0, 35, 90)
            gen_cross_contour_xld (Cross, FillLevelHeight[Idx], ColumnEdges[Idx], 15, 0)
            gen_rectangle2 (FillLevel, FillLevelHeight[Idx], ColumnEdges[Idx], 0, 28, 20)
            Errors := Errors + 1
            dev_set_color ('red')
            dev_display (ChamberSingle)
            disp_message (WindowHandle, 'NG', 'image', FillLevelHeight[Idx] - 50, ColumnEdges[Idx] - 10, 'red', 'false')
        else
            disp_message (WindowHandle, 'OK', 'image', FillLevelHeight[Idx] - 50, ColumnEdges[Idx] - 10, 'green', 'false')
            dev_set_color ('green')
        endif
        dev_display (FillLevel)
        dev_display (Cross)
    endfor
    
    * 如果有一个NG，则显示不良品，否则为良品
    if (Errors > 0)
        disp_message (WindowHandle, Errors + ' BAD', 'window', 10, 12, 'red', 'true')
    else
        disp_message (WindowHandle, 'All OK', 'window', 10, 12, 'forest green', 'true')
    endif
    
    * 显示设置
    if (Index < NumImages)
        disp_continue_message (WindowHandle, 'black', 'true')
        stop ()
    endif
endfor
* 清除测量对象句柄
close_measure (MeasureHandle)
* 清除模板句柄
clear_shape_model (ModelID)


```

