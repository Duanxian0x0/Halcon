## 缺陷检测解决策略之四光度立体法
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/f6c808b2777d4a769d1bbdf6fbbc5522.png)

```cpp

* 获取高度特征的信息图（缺陷在高度比较敏感）

* 读取四个角度的图像
read_image (Images, 'photometric_stereo/blister_back_0' + [1:4])

* 利用广度立体算子，得到对应反照率图和表面梯度图

* 输入四张图像
* 输出参数：物体表面的高度图像
* 输出图像：梯度图像
* 输出图像：反照率图像

* 输入参数：倾斜角度为90表示光线来自顶部，倾斜角度为180表示 光是从左边来的
Tilts := [6.1,95.0,-176.1,-86.8]
* 输入参数：物平面与照明方向之间的角度
Slants := [41.4,42.6,41.7,40.9]
* 输入参数：哪些结果图
ResultType := ['gradient','albedo']
photometric_stereo (Images, HeightField, Gradient, Albedo, Slants, Tilts, ResultType, 'poisson', [], [])


* 利用表面梯度图，计算表面的高斯曲率
derivate_vector_field (Gradient, Result, 1, 'gauss_curvature')


regiongrowing (Result, Regions, 1, 1, 0.001, 250)



* 转正数
abs_image (Result, ImageAbs)

*拉伸到0-255之间
scale_image_max (ImageAbs, ImageScaleMax)
* 定位（blob、几何定位）
gen_circle (ROI_0, 144.5, 388.295, 75.3545)
reduce_domain (ImageScaleMax, ROI_0, ImageReduced)

threshold (ImageReduced, Region, 50, 255)


connection (Region, ConnectedRegions)
select_shape (ConnectedRegions, SelectedRegions, 'area', 'and', 5, 99999)

count_obj (SelectedRegions, Number)
if(Number>0)
    dev_get_window (WindowHandle)
    disp_message (WindowHandle, 'NG', 'window', 12, 12, 'red', 'true')
endif
```

```cpp
* 该示例通过使用光度立体技术检测药片包装背面的缺陷
* 输入是4张不同的药片包装背面图片，光从不同的角度照射
 
dev_open_window (0, 0, 512, 512, 'black', WindowHandle)


* Show input images with different illumination
* 1 读图像，依次读取多张图像
* 下面的for循环，依次显示4张从不同角度拍摄的药片包装的背面图像
read_image (Images, 'photometric_stereo/blister_back_0' + [1:4])
for I := 1 to 4 by 1
    Message := 'Acquire image ' + I + ' of 4'
    select_obj (Images, ObjectSelected, I)
    dev_display (ObjectSelected)
    disp_message (WindowHandle, Message, 'window', 12, 12, 'black', 'true')
    wait_seconds (0.5)
endfor

* 2. 应用光度立体得到反照率图像和表面梯度图像
 
* 描述了从图像中心指向右侧的方向与投射到平面中的光的方向之间的角度。 
* 也就是说，当观察图像（或相应的场景）时，倾斜角度为0表示光线来自右侧，
* 倾斜角度为90表示光线来自顶部，倾斜角度为180表示 光是从左边来的
Tilts := [6.1,95.0,-176.1,-86.8]
* 物平面与照明方向之间的角度
Slants := [41.4,42.6,41.7,40.9]
ResultType := ['gradient','albedo']
* 该算子得到反照率图像和表面梯度图像
photometric_stereo (Images, HeightField, Gradient, Albedo, Slants, Tilts, ResultType, 'poisson', [], [])
* 
* Display the albedo image
* 显示反照率图像
dev_display (Albedo)
disp_message (WindowHandle, 'Albedo image', 'window', 12, 12, 'black', 'true')
disp_continue_message (WindowHandle, 'black', 'true')
stop ()


* 3. 使用之前得到的表面梯度，计算表面的高斯曲率，得到高斯曲率图像

* 在曲率图像上能更容易的进行检测
* 该算子通过之前得到的表面梯度得到高斯曲率图像
derivate_vector_field (Gradient, GaussCurvature, 1, 'gauss_curvature')

* 检测缺陷


* 4. 对高斯曲率图像进行预处理和Blob分析，从而得到缺陷区域
* （定位）
* 在曲率图像中，我们先分开各个药片区域
* 使用区域生长对图像进行分割（定位）
regiongrowing (GaussCurvature, Regions, 1, 1, 0.001, 250)
* 通过宽和高的特征，进行特征选择
select_shape (Regions, TabletRegions, ['width','height'], 'and', [150,150], [200,200])
* 凸性形状转换，针对区域
shape_trans (TabletRegions, TabletRegions, 'convex')
* 区域联合
union1 (TabletRegions, TabletRegions)
* 腐蚀
erosion_circle (TabletRegions, TabletRegions, 3.5)
* Search for defects inside the tablet areas
* 在药片区域搜寻缺陷
* 抠图
reduce_domain (GaussCurvature, TabletRegions, ImageReduced)
* 计算图像各个像素的绝对值，存在此次处理的原因是：高斯曲率图像存在负值


*****
* 缺陷提取
*****
* 重要预处理操作
* 缺陷处，高斯曲率会比较大（计算图像的绝对值）
abs_image (ImageReduced, ImageAbs)
* 二值化 ，灰度直方图
threshold (ImageAbs, Region, 0.03, 255)
* 闭运算
closing_circle (Region, RegionClosing, 10.5)
* 断开得到连通域
connection (RegionClosing, ConnectedRegions)
* 通过面积特征，进行特征选择
select_shape (ConnectedRegions, Defects, 'area', 'and', 10, 99999)
* 获得缺陷区域的中心点行列坐标
area_center (Defects, Area, Row, Column)
* 生成圆形区域
gen_circle (Circle, Row, Column, gen_tuple_const(|Row|,20.5))

* 5. 接下来在高斯曲率图像中标记缺陷区域
dev_set_draw ('margin')
dev_set_color ('red')
dev_set_line_width (2)
dev_display (GaussCurvature)
dev_display (Circle)
Message := 'The defect can easily be detected'
Message[1] := 'in the surface curvature image'
disp_message (WindowHandle, Message, 'window', 12, 12, 'black', 'true')
stop ()

* 6. 在反照率图像中标记出缺陷
dev_set_draw ('margin')
dev_set_color ('red')
dev_display (Albedo)
dev_display (Circle)
disp_message (WindowHandle, 'Defect in albedo image', 'window', 12, 12, 'black', 'true')

```

在Halcon中，`photometric_stereo`算子用于从多张不同光照条件下的图像中恢复物体的表面形状（高度场、梯度场等）。以下是该算子各参数的详细解释：

---

### **算子原型**
```halcon
photometric_stereo(
    Images,                  // 输入图像组
    HeightField,             // 输出高度场
    Gradient,                // 输出梯度场
    Albedo,                  // 输出反照率
    Slants,                  // 光源倾斜角（输入）
    Tilts,                   // 光源方位角（输入）
    ResultType,              // 输出类型
    'poisson',               // 重建方法（固定为'poisson'）
    [],                      // 保留参数（通常不用）
    []                       // 保留参数（通常不用）
)
```

---

### **参数详解**

1. **`Images`** (输入)  
   - **类型**: 图像数组（`HObject`数组）  
   - **作用**: 包含多张（通常≥3）同一场景在不同光照条件下的图像。每张图像对应一个特定的光源方向。  
   - **注意**: 图像需已对齐，且物体表面为漫反射材质。

2. **`HeightField`** (输出)  
   - **类型**: 单通道浮点图像（`HObject`）  
   - **作用**: 输出的表面高度场（Z坐标），表示物体表面各点相对于基准平面的高度。

3. **`Gradient`** (输出)  
   - **类型**: 两通道浮点图像（`HObject`数组，`[GradientX, GradientY]`）  
   - **作用**: 输出的表面梯度场，包含X和Y方向的斜率（`dz/dx`和`dz/dy`）。

4. **`Albedo`** (输出)  
   - **类型**: 单通道浮点图像（`HObject`）  
   - **作用**: 输出的反照率（Albedo），反映物体表面材质对光照的反射强度（与光照无关的固有属性）。

5. **`Slants`** (输入)  
   - **类型**: 浮点数组（`HTuple`）  
   - **作用**: 每个光源的倾斜角（与Z轴的夹角），单位为弧度。例如：`[0.5, 1.0, ...]`。

6. **`Tilts`** (输入)  
   - **类型**: 浮点数组（`HTuple`）  
   - **作用**: 每个光源的方位角（在XY平面内的旋转角），单位为弧度。例如：`[0, 3.14, ...]`。

7. **`ResultType`** (输入)  
   - **类型**: 字符串（`HTuple`）  
   - **可选值**:  
     - `'height'`：仅输出高度场（`HeightField`）。  
     - `'gradient'`：仅输出梯度场（`Gradient`）。  
     - `'albedo'`：仅输出反照率（`Albedo`）。  
     - `'all'`：输出所有结果（默认）。  

8. **`'poisson'`** (固定参数)  
   - **作用**: 指定使用**泊松重建**方法从梯度场计算高度场。此参数为固定值，不可更改。

9. **`[]`** (保留参数)  
   - **作用**: 通常留空，用于未来扩展或兼容性。

---

### **关键点说明**
- **光照方向**：`Slants`和`Tilts`需与`Images`数组中的图像顺序一一对应。  
- **输出选择**：通过`ResultType`控制需要计算的输出（如仅高度场或反照率）。  
- **泊松重建**：`'poisson'`方法通过求解泊松方程从梯度场恢复高度场，适合闭合连续表面。

---

### **示例代码**
```halcon
* 假设有4张图像，对应4个光源方向
Images := [Image1, Image2, Image3, Image4]
Slants := [0.5, 0.5, 0.5, 0.5]  * 倾斜角（弧度）
Tilts := [0, 1.57, 3.14, 4.71]  * 方位角（0, π/2, π, 3π/2）

photometric_stereo(Images, HeightField, Gradient, Albedo, Slants, Tilts, 'all', 'poisson', [], [])
```

通过此算子，可同时获得物体的3D形状（高度场/梯度）和材质属性（反照率）。
