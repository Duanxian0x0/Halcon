## 缺陷检测解决策略之三频域+空域_05(纹理获取)


![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/bb15aabb793345c18c12dc2857ee8d6e.png)

```cpp
* 傅里叶变换
* blob分析阈值分割，来做滤波核

read_image (Image, 'plan_01')

* 获取图像大小
get_image_size (Image, Width, Height)
* 优化傅里叶速度的算子
optimize_fft_speed (Width, Height, 'standard')

* 傅里叶变换
fft_generic (Image, ImageFFT, 'to_freq', -1, 'sqrt', 'dc_center', 'complex')

* 功率谱图

power_real (ImageFFT, ImageResult)

* 滤波
binomial_filter (ImageResult, ImageBinomial, 9, 9)

* 阈值分割提取
threshold (ImageBinomial, Region, 30, 255)

* 打散
connection (Region, ConnectedRegions)

* 选取四周区域
select_shape (ConnectedRegions, SelectedRegions, 'area', 'and', 5, 200)

* 膨胀区域，稳定去除
dilation_circle (SelectedRegions, RegionDilation, 5.5)

* 滤波核制作
paint_region (RegionDilation, ImageFFT, ImageResult1, 0, 'fill')

* 反傅里叶变换
fft_generic (ImageResult1, ImageFFT1, 'from_freq', 1, 'sqrt', 'dc_center', 'byte')

* 差分，提取纹理
sub_image (Image, ImageFFT1, ImageSub, 1, 128)

* 负责：灵活性非常高
* 双边滤波：简单
```

```cpp

dev_update_off ()
dev_close_window ()
* 比例
Scale := [1.0,.65]
* 最小灰度
MinGray := [50,100]


* 两次检测
for Index := 0 to 1 by 1
    * 
    * 读取图像
    read_image (Image, 'plan_' + (Index + 1)$'02')
    get_image_size (Image, Width, Height)
    dev_open_window (0, 0, Width * Scale[Index], Height * Scale[Index], 'black', WindowHandle)
    set_display_font (WindowHandle, 14, 'mono', 'true', 'false')
    dev_set_part (0, 0, Height - 1, Width - 1)
    dev_display (Image)
    disp_message (WindowHandle, 'Original image', 'window', 12, 12, 'black', 'true')
    * 
    * 优化傅里叶速度
    optimize_fft_speed (Width, Height, 'standard')
    * 傅里叶变换
    fft_generic (Image, ImageFFT, 'to_freq', -1, 'sqrt', 'dc_center', 'complex')
    dev_open_window (0, Width * Scale[Index] + 7, Width * Scale[Index], Height * Scale[Index], 'black', WindowHandle1)
    dev_set_color ('red')
    dev_set_draw ('margin')
    set_display_font (WindowHandle1, 14, 'mono', 'true', 'false')
    dev_set_part (0, 0, Height - 1, Width - 1)
    dev_display (ImageFFT)
    disp_message (WindowHandle1, 'Fourier spectrum', 'window', 12, 12, 'black', 'true')

    stop ()
    * 
    * 返回复图像的功率谱
    power_real (ImageFFT, PowerSpectrum)
    * 滤波器
    binomial_filter (PowerSpectrum, ImageSmooth, 9, 9)
    * 阈值分割
    threshold (ImageSmooth, Region, MinGray[Index], 100000)
    * 连通
    connection (Region, ConnectedRegions)
    * 选取
    select_shape (ConnectedRegions, SelectedRegions, 'area', 'and', 5, 200)
    * 合并
    union1 (SelectedRegions, RegionUnion)
    * 获取区域图像
    reduce_domain (ImageSmooth, RegionUnion, ImageReduced)
    * 检测图像中的所有局部最大值。
    local_max (ImageReduced, LocalMaxima)
    * 转为突变形
    shape_trans (LocalMaxima, RegionTrans, 'convex')
    * 仿射变换
    hom_mat2d_identity (HomMat2DIdentity)
    hom_mat2d_scale (HomMat2DIdentity, 2.1, 2.1, Height / 2, Width / 2, HomMat2DScale)
    affine_trans_region (RegionTrans, RegionTrans1, HomMat2DScale, 'nearest_neighbor')
    hom_mat2d_scale (HomMat2DIdentity, 1.9, 1.9, Height / 2, Width / 2, HomMat2DScale)
    affine_trans_region (RegionTrans, RegionTrans2, HomMat2DScale, 'nearest_neighbor')
    * 区域相减
    difference (RegionTrans1, RegionTrans2, RegionDifference)
    * 获取区域图像
    reduce_domain (ImageSmooth, RegionDifference, ImageReduced)
    * 阈值分割
    threshold (ImageReduced, Region, 15, 100000)
    * 获取区域图像
    reduce_domain (ImageSmooth, Region, ImageReduced)
    * 检测图像中的所有局部最大值。
    local_max (ImageReduced, LocalMaxima2)
    * 区域合并
    union2 (LocalMaxima, LocalMaxima2, RegionUnion)
    * 膨胀
    dilation_circle (RegionUnion, RegionDilation, 15.5)
    * 绘制区域
    paint_region (RegionDilation, ImageFFT, ImageFFTFiltered, 0, 'fill')
    dev_display (ImageFFT)
    dev_display (RegionDilation)
    disp_message (WindowHandle1, 'Frequencies of the\nbackground texture', 'window', 12, 12, 'black', 'true')

    stop ()
    * 
    * 反傅里叶变换
    fft_generic (ImageFFTFiltered, ImageFiltered, 'from_freq', 1, 'sqrt', 'dc_center', 'byte')
    dev_display (ImageFiltered)
    disp_message (WindowHandle1, 'Filtered image', 'window', 12, 12, 'black', 'true')
    
    dev_open_window (0, 2 * (Width * Scale[Index]) + 14, Width * Scale[Index], Height * Scale[Index], 'black', WindowHandle2)
    set_display_font (WindowHandle2, 14, 'mono', 'true', 'false')
    dev_set_part (0, 0, Height - 1, Width - 1)
    * 图像相减（获取纹理）
    sub_image (Image, ImageFiltered, ImageTexture, 1, 128)
    dev_display (ImageTexture)
    disp_message (WindowHandle2, 'Removed texture', 'window', 12, 12, 'black', 'true')
    if (Index < 1)
        stop ()
        dev_close_window ()
        dev_close_window ()
        dev_close_window ()
    endif
endfor

```

