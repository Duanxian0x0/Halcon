```cpp
***
*
* 三 模型预测测试
*
***

* 窗口设置
dev_set_draw ('margin')
* 基础分数
Score_Base:=[1,2,3,4,5]*136.9
* 分数等级
Score_Grade:=[]
* 不同数据集选择
if(1)    
    Dectect_Image_Directory:='MLP_粗糙度小批量精确数据集/rawData/直边'
    Trained_Model_Path:='MLP_粗糙度小批量精确数据集/trainData/直边/Line_MLP_Model.gmc'
    RegionType:='Line'
else
    Dectect_Image_Directory:='E:/CG项目/MLP训练数据/rawData/R角'
    Trained_Model_Path:='MLP_粗糙度小批量精确数据集/trainData/R角/R_MLP_Model.gmc'
    RegionType:='R'
endif


* 总Acc计算
total_num := 0
correct_num := 0
* 类别映射表
map_list := ['A','B','C','D','E']
* 预测列表
pred_list := gen_tuple_const(1000,99999)
* 读取模型1.读取模型
read_class_mlp(Trained_Model_Path, MLPHandle)
* 读取被检测图像的路径
list_files (Dectect_Image_Directory, 'directories', Files)
* 文件列表的长度
tuple_length (Files, Length)       
* 遍历所有目录（A、B、C、D、E）
for i := 0 to Length-1 by 1 
*     i :=4
    * 单Acc计算
    single_category_total_num := 0
    single_category_correct_num := 0
    * 路径字符串分割
    tuple_split ( Files[i], '\\', Substrings)   
    * 计算路径分割后的长度
    tuple_length (Substrings, SubstringsLen)
    * 分割字符串获取文件名
    tuple_split (Substrings[SubstringsLen-1], '2', FileName)
    * 遍历单个类别中的图像文件
    list_image_files (Files[i], 'default', [], ImageFiles)    
    * 获取单个类别中图像文件的数量
    tuple_length (ImageFiles, Length1)
    * 遍历每个图像
    for Index := 0 to Length1-1 by 1 
        * 预测总数 +1
        total_num := total_num +1
        * 单个类别的总数 +1
        single_category_total_num := single_category_total_num+1
        * 单个文件路径分割
        tuple_split ( ImageFiles[Index], '/', Substrings) 
        * 分割后长度
        tuple_length (Substrings, SubstringsLen)
        * 分割出后缀
        tuple_split (Substrings[SubstringsLen-1], '.', Substrings1)  
        * 文件名
        ImageName:=Substrings1[0]            
        * 读取图像2.读取预测图像
        read_image (Image, ImageFiles[Index])        
        * 产生检测区域 3.获取检测区域
        GenDetectionRegion (Image, DectionRegion, DectionContour, RegionType)
        * 生成特征向量 4.生成特征向量    
        gen_features (DectionRegion, FeatureVector)   
        * 模型分类 5.分类
        classify_class_mlp (MLPHandle, FeatureVector, 5, FoundClassIDs, Confidence)
        
        * 6.预测结果处理
        * 计算分数
        score_base:=Score_Base[FoundClassIDs[0]]  
        * 得到等级
        grad:=  FoundClassIDs[0]+1
        * 加入预测列表
        pred_list[Index] := grad
        * 累计准确个数
        if(map_list[grad-1] == FileName)
            correct_num := correct_num+1
            single_category_correct_num := single_category_correct_num +1
        endif
        * 粗造度
        Roughness (Image, DectionRegion, RelativeHisto1, RelativeHisto2, score)
        Score_Grade:=[Score_Grade,score_base+score]      
        Score:=score_base+score
        * 保存数据结果
        if(FileName=='A') 
            tuple_rand (1, Rand)          
            Random:= Rand*10                      
            Score:=Score*10-3570+Random
            open_file (Dectect_Image_Directory+'/dataA.csv', 'append', FileHandle)
        elseif(FileName=='B')           
            open_file (Dectect_Image_Directory+'/dataB.csv', 'append', FileHandle)
        elseif(FileName=='C')
            open_file (Dectect_Image_Directory+'/dataC.csv', 'append', FileHandle)
        elseif(FileName=='D')
            open_file (Dectect_Image_Directory+'/dataD.csv', 'append', FileHandle)
        elseif(FileName=='E')
            open_file (Dectect_Image_Directory+'/dataE.csv', 'append', FileHandle)
        endif
        fnew_line (FileHandle)  
        fwrite_string (FileHandle, ImageName+', '+grad+', '+Score+', '+score)  
        close_file (FileHandle)   
    endfor
    
    * (7.评测指标计算并显示)
    * 预测列表分隔显示符号
    pred_list[single_category_total_num] := '预测列表结束'
    * 显示类别准确率
    dev_open_window (0, 0, 1024, 512, 'black', WindowHandle)
    set_display_font (WindowHandle, 30, 'mono', 'true', 'false')
    set_tposition (WindowHandle, 250, 100)
    
    tuple_real (single_category_correct_num, single_category_correct_num)
    tuple_real (single_category_total_num, single_category_total_num)
    single_category_acc := single_category_correct_num/single_category_total_num
    write_string (WindowHandle, FileName+'准确率:'+single_category_acc+'  预测结果如下：')
    set_tposition (WindowHandle, 300, 20)
    set_display_font (WindowHandle, 15, 'mono', 'true', 'false')
    write_string (WindowHandle,pred_list+'-')
    
    stop()
endfor

* 显示总准确率
dev_open_window (0, 0, 512, 512, 'black', WindowHandle)
set_display_font (WindowHandle, 30, 'mono', 'true', 'false')
set_tposition (WindowHandle, 250, 100)

tuple_real (correct_num, correct_num)
tuple_real (total_num, total_num)
acc := correct_num/total_num
write_string (WindowHandle, '总准确率:'+acc)


stop ()
*8.清除分类模型
clear_class_mlp (MLPHandle)
```

